<!DOCTYPE html>
<html ng-app="d2h_App" ng-app lang="ca">
<head>
    <meta charset="utf-8">

    <link href="../outside/bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../outside/angular-ui/ui-select-0.13.2/dist/select.min.css" rel="stylesheet">
    <style type="text/css">
    a {cursor: pointer;}
    span.glyphicon.d2h_sortActivated {color:red}
    /* 
    [ng-cloak] is used to prevent show templates, see:
        https://docs.angularjs.org/api/ng/directive/ngCloak
    */
    [ng-cloak] {  display: none !important; }
    .red {color:red}
    </style>
    <script src="../outside/angular-1.4.8/angular.min.js"></script>
    <script src="../outside/angular-1.4.8/angular-sanitize.min.js"></script>
    <script src="../outside/angular-1.4.8/i18n/angular-locale_ca.js"></script>
    <script src="../outside/angular-ui/ui-bootstrap-tpls-1.0.3.min.js"></script>
    <script src="../outside/angular-ui/ui-select-0.13.2/dist/select.min.js"></script>
    <script>
        var d2h_App = angular.module('d2h_App', ['ui.bootstrap', 'ngSanitize', 'ui.select']);
        var d2h_local = {};
    </script>

    <title>Simple Datagrid with search, sort and paging using AngularJS, PHP, MySQL</title>
</head>
<body>
<div class="container">
<div ng-controller="d2h_1_aixada_accounts">
    <div class="row"  form="form" ng-controller="d2h_1_aixada_accounts_filter">
        <form novalidate class="simple-form">
        <div>
            <div class="col-md-3">Filter:
                <input type="text" placeholder="Filter" class="form-control" 
                    ng-model="search"
                />
            </div>
            <span class="col-md-3" ng-controller="d2h_2_account_id_EQ">account_id_EQ:
                <ui-select
                    ng-model="d2h_filter.account_id_EQ"
                    theme="bootstrap"
                    ng-disabled="disabled"
                >
                    <ui-select-match 
                        placeholder="account_id_EQ"
                    >{{$select.selected.text}}</ui-select-match>
                    <ui-select-choices 
                        repeat="item.value as item in data | filter: $select.search">
                        <span ng-bind-html="item.text | highlight: $select.search"></span>
                    </ui-select-choices>
                </ui-select>
            </span>
            <script>
                d2h_App.controller('d2h_2_account_id_EQ', function($scope, $http) {
                    $scope.disabled = undefined;

                    $scope.enable = function() {
                        $scope.disabled = false;
                    };
                    $scope.disable = function() {
                        $scope.disabled = true;
                    };
                    $scope.clear = function() {
                        $scope.selected = undefined;
                    };
                    $scope.item = {};
                    $http({
                        method: 'POST',
                        url: '_controller.php?model=aixada_ufs:account&lang=ca',
                        headers: {
                            'Content-Type': undefined
                        },
                        data: {d2h_oper: 'read'}
                    }).then(
                        function(response) { // Ok
                            $scope.data = response.data.rows;
                        }, function(response) { // Error
                            console.log(response.status);
                        }
                    );
                });  
            </script>
            <div class="col-md-3">description_EQ:
                <input type="text" 
                    placeholder="description_EQ"
                    class="form-control" 
                    ng-model="d2h_filter.description_EQ"
                >
            </div>
            <input type="button" ng-click="reset(form)" value="Reset" />
            <input type="submit" ng-click="initialPage()" value="Filter" />
        </div>
        </form>
    </div>
    <div class="row">
        <div class="col-md-12" id="d2h_1_aixada_accounts">
            <h3>Diners</h3>
            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th>id <a
                        title="ordre creixent"
                        ng-click="sortBy('id', false);"><span
                        aria-label="ordre creixent" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='id' && !reverse}"
                        class="glyphicon glyphicon-sort-by-alphabet"></span></a><a
                        title="ordre invers"
                        ng-click="sortBy('id', true);"><span
                        aria-label="ordre invers" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='id' && reverse}"
                        aria-hidden="true"
                        class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a></th>
                    <th>Usuari <a
                        title="ordre creixent"
                        ng-click="sortBy('operator', false);"><span
                        aria-label="ordre creixent" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='operator' && !reverse}"
                        class="glyphicon glyphicon-sort-by-alphabet"></span></a><a
                        title="ordre invers"
                        ng-click="sortBy('operator', true);"><span
                        aria-label="ordre invers" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='operator' && reverse}"
                        aria-hidden="true"
                        class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a></th>
                    <th>description <a
                        title="ordre creixent"
                        ng-click="sortBy('description', false);"><span
                        aria-label="ordre creixent" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='description' && !reverse}"
                        class="glyphicon glyphicon-sort-by-alphabet"></span></a><a
                        title="ordre invers"
                        ng-click="sortBy('description', true);"><span
                        aria-label="ordre invers" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='description' && reverse}"
                        aria-hidden="true"
                        class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a></th>
                    <th>method <a
                        title="ordre creixent"
                        ng-click="sortBy('method', false);"><span
                        aria-label="ordre creixent" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='method' && !reverse}"
                        class="glyphicon glyphicon-sort-by-alphabet"></span></a><a
                        title="ordre invers"
                        ng-click="sortBy('method', true);"><span
                        aria-label="ordre invers" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='method' && reverse}"
                        aria-hidden="true"
                        class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a></th>
                    <th>quantity <a
                        title="ordre creixent"
                        ng-click="sortBy('quantity', false);"><span
                        aria-label="ordre creixent" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='quantity' && !reverse}"
                        class="glyphicon glyphicon-sort-by-alphabet"></span></a><a
                        title="ordre invers"
                        ng-click="sortBy('quantity', true);"><span
                        aria-label="ordre invers" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='quantity' && reverse}"
                        aria-hidden="true"
                        class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a></th>
                    <th>balance <a
                        title="ordre creixent"
                        ng-click="sortBy('balance', false);"><span
                        aria-label="ordre creixent" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='balance' && !reverse}"
                        class="glyphicon glyphicon-sort-by-alphabet"></span></a><a
                        title="ordre invers"
                        ng-click="sortBy('balance', true);"><span
                        aria-label="ordre invers" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='balance' && reverse}"
                        aria-hidden="true"
                        class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a></th>
                    <th>data <a
                        title="ordre creixent"
                        ng-click="sortBy('ts', false);"><span
                        aria-label="ordre creixent" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='ts' && !reverse}"
                        class="glyphicon glyphicon-sort-by-alphabet"></span></a><a
                        title="ordre invers"
                        ng-click="sortBy('ts', true);"><span
                        aria-label="ordre invers" aria-hidden="true"
                        ng-class="{d2h_sortActivated: predicate=='ts' && reverse}"
                        aria-hidden="true"
                        class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a></th>
                </tr>
                </thead>
                <tfoot ng-show="filtered.length > 0" ng-cloak>
                <tr>
                    <td colspan="8">
                        <div class="form-inline">
                            <button class="btn btn-default hidden-xs "
                                title="Refresh data"
                                ng-click="initialPage()"
                            >
                                <span class="glyphicon glyphicon-refresh"
                                    aria-label="Refresh data"
                                    aria-hidden="true"></span>
                            </button>
                            <select class="form-control" style="padding:0;"
                                title="Rows per page"
                                ng-model="pageSize"
                                ng-init="pageSize=pageSizeOp[0].value"
                                ng-change="initialPage()"
                                ng-options="opt.value as opt.text for opt in pageSizeOp"
                            ></select>
                            <button class="btn btn-default"
                                title="Next page"
                                ng-click="nextPage()"
                            >
                                <span class="glyphicon glyphicon-forward"
                                    aria-hidden="true"></span>
                                <span class="hidden-xs hidden-sm">
                                    Next page
                                </span>
                            </button>
                            <span
                                ng-init="start()"
                            ng-cloak>
                                Filtered {{filtered.length}} of {{data.length}}
                            </span>
                        </div>
                    </td>
                </tr>
                </tfoot>
                <tbody ng-show="filtered.length > 0" ng-cloak>
                <tr 
                       ng-repeat="item in filtered = (data | filter:search | orderBy :predicate :reverse)">
                    <td class="text-right">{{item.id}}</td>
                    <td>{{item.operator}}</td>
                    <td>{{item.description}}</td>
                    <td>{{item.method}}</td>
                    <td ng-class="{red:item.quantity<0}" class="text-right">{{item.quantity | number:'2'}}</td>
                    <td ng-class="{red:item.balance<0}" class="text-right">{{item.balance | currency}}</td>
                    <td>{{item.ts | date:'dd-MM-yy HH:mm'}}</td>
                </tr>
                </tbody>
            </table>
            <div
            class="alert alert-warning" role="alert"
            ng-show="filtered.length == 0" ng-cloak>
                No data found
            </div>
        </div>
    </div>
</div>
<script>
d2h_App.controller('d2h_1_aixada_accounts', function ($scope, $http) {
    $scope.d2h_filter={};
    // server
    var _req = function() {
        return {
            method: 'POST',
            url: '_controller.php?model=aixada_accounts&lang=ca',
            headers: {
                'Content-Type': undefined
            },
            data: {
                d2h_oper: 'read',
                d2h_filter: $scope.d2h_filter,
                d2h_page: {
                    pageSize: $scope.pageSize,
                    pageStart: $scope.pageStart
                }
            }
        };
    };
    
    $scope.initialPage = function() {
        $scope.pageStart = 1; //current page
        $http(_req()).then(
            function(response) { // Ok
                $scope.data = response.data.rows;
                // $scope.status = response.status;
            }, function(response) { // Error
                // $scope.data = response.data || "Request failed";
                // $scope.status = response.status;
                console.log("IRROR");
            }
        );
    };
    $scope.nextPage = function() {
        $scope.pageStart += $scope.pageSize;
        $http(_req()).then(
            function(response) { // Ok
                Array.prototype.push.apply(
                    $scope.data,
                    response.data.rows
                );
            }, function(response) { // Error
                console.log("IRROR");
            }
        );
    };
    
    // local
    var pageSizes = [10, 20, -4, -3, 50, 100];
    $scope.pageSizeOp = [];
    for (i = 0, len = pageSizes.length; i < len; i++) {
        $scope.pageSizeOp.push({
            value: pageSizes[i],
            'text': pageSizes[i]+''
        });
    }
    $scope.sortBy = function(predicate, reverse) {
        $scope.predicate = predicate;
        $scope.reverse = reverse;
    };
    $scope.start = function() {
        $scope.initialPage();
        $scope.sortBy('id', true);
    };
});
</script>
</div>
</body>
</html>
